diff -urN civicrm-4.2.19/CRM/Admin/Form/Setting/Localization.php civicrm-4.2.19-wmf/CRM/Admin/Form/Setting/Localization.php

Status: Needs upstreaming:
Background: This hasn't been agreed yet but CiviCRM assumes a default language whereas WMF thinks that should not be stored
JIRA: CRM-14232

--- civicrm-4.2.19/CRM/Admin/Form/Setting/Localization.php	2014-09-09 15:40:20.000000000 -0700
+++ civicrm-4.2.19-wmf/CRM/Admin/Form/Setting/Localization.php	2015-03-11 13:31:10.194248479 -0700
@@ -97,6 +97,8 @@
       }
     }
 
+    $this->addElement('checkbox', 'contactLanguageHasDefault', ts('New contacts have default language'));
+
     $this->addElement('checkbox', 'inheritLocale', ts('Inherit CMS Language'));
     $this->addElement('text', 'monetaryThousandSeparator', ts('Thousands Separator'), array('size' => 2));
     $this->addElement('text', 'monetaryDecimalPoint', ts('Decimal Delimiter'), array('size' => 2));
@@ -227,6 +229,10 @@
       $values['inheritLocale'] = 0;
     }
 
+    if (!isset($values['contactLanguageHasDefault'])) {
+      $values['contactLanguageHasDefault'] = 0;
+    }
+
     //cache contact fields retaining localized titles
     //though we changed localization, so reseting cache.
     CRM_Core_BAO_Cache::deleteGroup('contact fields');
diff -urN civicrm-4.2.19/CRM/Contact/BAO/Contact.php civicrm-4.2.19-wmf/CRM/Contact/BAO/Contact.php
--- civicrm-4.2.19/CRM/Contact/BAO/Contact.php	2014-09-09 15:40:20.000000000 -0700
+++ civicrm-4.2.19-wmf/CRM/Contact/BAO/Contact.php	2015-03-11 13:31:10.218248478 -0700
@@ -267,8 +267,10 @@
     $config = CRM_Core_Config::singleton();
 
     // CRM-6942: set preferred language to the current language if it’s unset (and we’re creating a contact)
-    if (empty($params['contact_id']) && empty($params['preferred_language'])) {
-      $params['preferred_language'] = $config->lcMessages;
+    if ($config->contactLanguageHasDefault) {
+        if (empty($params['contact_id']) && empty($params['preferred_language'])) {
+          $params['preferred_language'] = $config->lcMessages;
+        }
     }
 
     // CRM-9739: set greeting & addressee if unset and we’re creating a contact
diff -urN civicrm-4.2.19/CRM/Contact/DAO/Contact.php civicrm-4.2.19-wmf/CRM/Contact/DAO/Contact.php
--- civicrm-4.2.19/CRM/Contact/DAO/Contact.php	2014-09-09 15:41:40.000000000 -0700
+++ civicrm-4.2.19-wmf/CRM/Contact/DAO/Contact.php	2015-03-11 13:31:10.226248478 -0700
@@ -592,8 +592,8 @@
                     'name' => 'preferred_language',
                     'type' => CRM_Utils_Type::T_STRING,
                     'title' => ts('Preferred Language') ,
-                    'maxlength' => 5,
-                    'size' => CRM_Utils_Type::EIGHT,
+                    'maxlength' => 32,
+                    'size' => CRM_Utils_Type::MEDIUM,
                     'import' => true,
                     'where' => 'civicrm_contact.preferred_language',
                     'headerPattern' => '/^lang/i',
diff -urN civicrm-4.2.19/CRM/Contact/Form/Edit/CommunicationPreferences.php civicrm-4.2.19-wmf/CRM/Contact/Form/Edit/CommunicationPreferences.php
--- civicrm-4.2.19/CRM/Contact/Form/Edit/CommunicationPreferences.php	2014-09-09 15:40:20.000000000 -0700
+++ civicrm-4.2.19-wmf/CRM/Contact/Form/Edit/CommunicationPreferences.php	2015-03-11 13:31:10.230248478 -0700
@@ -83,7 +83,7 @@
     $form->add('select', 'preferred_language',
       ts('Preferred Language'),
       array(
-        '' => ts('- select -')) +
+        '' => ts('- unknown -')) +
       CRM_Core_PseudoConstant::languages()
     );
 
@@ -169,9 +169,11 @@
     }
 
     // CRM-7119: set preferred_language to default if unset
-    if (empty($defaults['preferred_language'])) {
-      $config = CRM_Core_Config::singleton();
-      $defaults['preferred_language'] = $config->lcMessages;
+    if ($config->contactLanguageHasDefault) {
+      if (empty($defaults['preferred_language'])) {
+        $config = CRM_Core_Config::singleton();
+        $defaults['preferred_language'] = $config->lcMessages;
+      }
     }
 
     //set default from greeting types CRM-4575, CRM-9739
diff -urN civicrm-4.2.19/CRM/Contact/Form/Inline/CommunicationPreferences.php civicrm-4.2.19-wmf/CRM/Contact/Form/Inline/CommunicationPreferences.php
--- civicrm-4.2.19/CRM/Contact/Form/Inline/CommunicationPreferences.php	2014-09-09 15:40:20.000000000 -0700
+++ civicrm-4.2.19-wmf/CRM/Contact/Form/Inline/CommunicationPreferences.php	2015-03-11 13:31:10.230248478 -0700
@@ -119,9 +119,11 @@
     }
 
     // CRM-7119: set preferred_language to default if unset
-    if (empty($defaults['preferred_language'])) {
-      $config = CRM_Core_Config::singleton();
-      $defaults['preferred_language'] = $config->lcMessages;
+    if ($config->contactLanguageHasDefault) {
+      if (empty($defaults['preferred_language'])) {
+        $config = CRM_Core_Config::singleton();
+        $defaults['preferred_language'] = $config->lcMessages;
+      }
     }
 
     foreach (CRM_Contact_BAO_Contact::$_greetingTypes as $greeting) {
diff -urN civicrm-4.2.19/CRM/Core/BAO/UFGroup.php civicrm-4.2.19-wmf/CRM/Core/BAO/UFGroup.php
--- civicrm-4.2.19/CRM/Core/BAO/UFGroup.php	2014-09-09 15:40:20.000000000 -0700
+++ civicrm-4.2.19-wmf/CRM/Core/BAO/UFGroup.php	2015-03-11 13:31:10.282248477 -0700
@@ -1738,7 +1738,7 @@
       $form->add('select', $name, $title, CRM_Core_SelectValues::pmf());
     }
     elseif ($fieldName === 'preferred_language') {
-      $form->add('select', $name, $title, array('' => ts('- select -')) + CRM_Core_PseudoConstant::languages());
+      $form->add('select', $name, $title, array('' => ts('- unknown -')) + CRM_Core_PseudoConstant::languages());
     }
     elseif ($fieldName == 'external_identifier') {
       $form->add('text', $name, $title, $attributes, $required);
diff -urN civicrm-4.2.19/CRM/Core/Config/Variables.php civicrm-4.2.19-wmf/CRM/Core/Config/Variables.php
--- civicrm-4.2.19/CRM/Core/Config/Variables.php	2014-09-09 15:40:20.000000000 -0700
+++ civicrm-4.2.19-wmf/CRM/Core/Config/Variables.php	2015-03-11 13:31:10.286248477 -0700
@@ -129,6 +129,12 @@
   public $lcMessages = 'en_US';
 
   /**
+   * Whether new contacts default to $lcMessages (if config is true), or null.
+   * @var boolean
+   */
+  public $contactLanguageHasDefault = true;
+
+  /**
    * String format for date+time
    * @var string
    */
diff -urN civicrm-4.2.19/templates/CRM/Admin/Form/Setting/Localization.tpl civicrm-4.2.19-wmf/templates/CRM/Admin/Form/Setting/Localization.tpl
--- civicrm-4.2.19/templates/CRM/Admin/Form/Setting/Localization.tpl	2014-09-09 15:40:20.000000000 -0700
+++ civicrm-4.2.19-wmf/templates/CRM/Admin/Form/Setting/Localization.tpl	2015-03-11 13:31:10.658248467 -0700
@@ -32,6 +32,11 @@
                 <td>{$form.lcMessages.html}<br />
                 <span class="description">{ts}Default language used for this installation.{/ts}</span></td>
             </tr>
+            <tr class="crm-localization-form-block-contactLanguageHasDefault">
+                <td class="label">{$form.contactLanguageHasDefault.label}</td>
+                <td>{$form.contactLanguageHasDefault.html}<br />
+                <span class="description">{ts}New contacts without an explicit preferred_language will default to the site default language when this box is checked.  Otherwise, the contact language will default to empty, meaning it is unknown.{/ts}</span></td>
+            </tr>
            {if $form.languageLimit}
              <tr class="crm-localization-form-block-languageLimit"> 
                  <td class="label">{$form.languageLimit.label}</td>
